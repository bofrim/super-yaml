{
  "ansible_showcase": {
    "inventory": {
      "all": {
        "children": {
          "app_servers": {
            "hosts": {
              "app-01": {
                "ansible_host": "10.42.1.11",
                "ansible_port": 22,
                "datacenter": "pdx1",
                "node_role": "app",
                "rack": "r14"
              },
              "app-02": {
                "ansible_host": "10.42.1.12",
                "ansible_port": 22,
                "datacenter": "pdx1",
                "node_role": "app",
                "rack": "r14"
              },
              "app-03": {
                "ansible_host": "10.42.1.13",
                "ansible_port": 22,
                "datacenter": "pdx2",
                "node_role": "app",
                "rack": "r02"
              }
            },
            "vars": {
              "app_runtime": "container",
              "app_tier": "frontend"
            }
          },
          "worker_servers": {
            "hosts": {
              "worker-01": {
                "ansible_host": "10.42.2.21",
                "ansible_port": 22,
                "datacenter": "pdx2",
                "node_role": "worker",
                "rack": "r03"
              },
              "worker-02": {
                "ansible_host": "10.42.2.22",
                "ansible_port": 22,
                "datacenter": "pdx2",
                "node_role": "worker",
                "rack": "r03"
              },
              "worker-03": {
                "ansible_host": "10.42.2.23",
                "ansible_port": 22,
                "datacenter": "pdx3",
                "node_role": "worker",
                "rack": "r11"
              }
            },
            "vars": {
              "app_runtime": "process",
              "app_tier": "backend"
            }
          }
        },
        "vars": {
          "ansible_python_interpreter": "/usr/bin/python3",
          "ansible_user": "ansible",
          "deployment_region": "us-west"
        }
      }
    },
    "playbook": [
      {
        "any_errors_fatal": true,
        "become": true,
        "become_method": "sudo",
        "gather_facts": true,
        "handlers": [
          {
            "ansible.builtin.service": {
              "name": "storefront-api",
              "state": "restarted"
            },
            "name": "restart storefront-api"
          },
          {
            "ansible.builtin.service": {
              "name": "storefront-api",
              "state": "reloaded"
            },
            "name": "reload storefront-api"
          }
        ],
        "hosts": "app_servers",
        "max_fail_percentage": 25,
        "name": "Deploy storefront-api to app_servers",
        "pre_tasks": [
          {
            "ansible.builtin.apt": {
              "cache_valid_time": 3600,
              "update_cache": true
            },
            "name": "Ensure apt cache is up to date",
            "tags": [
              "bootstrap",
              "packages"
            ]
          },
          {
            "ansible.builtin.package": {
              "name": [
                "curl",
                "git",
                "unzip",
                "ca-certificates",
                "jq"
              ],
              "state": "present"
            },
            "name": "Install base operating system packages",
            "tags": [
              "bootstrap",
              "packages"
            ]
          },
          {
            "ansible.builtin.user": {
              "create_home": false,
              "name": "storefront",
              "shell": "/usr/sbin/nologin",
              "system": true
            },
            "name": "Create dedicated application user",
            "tags": [
              "identity"
            ]
          }
        ],
        "roles": [
          {
            "role": "datadog.datadog",
            "vars": {
              "datadog_checks": {
                "process": {
                  "init_config": {},
                  "instances": [
                    {
                      "exact_match": false,
                      "name": "storefront-api",
                      "search_string": [
                        "storefront-api"
                      ]
                    }
                  ]
                }
              },
              "datadog_site": "datadoghq.com"
            }
          },
          {
            "role": "geerlingguy.firewall",
            "vars": {
              "firewall_allowed_tcp_ports": [
                22,
                8080
              ]
            }
          }
        ],
        "serial": 1,
        "strategy": "linear",
        "tasks": [
          {
            "ansible.builtin.file": {
              "group": "storefront",
              "mode": "0755",
              "owner": "storefront",
              "path": "/srv/apps/storefront-api",
              "state": "directory"
            },
            "name": "Ensure release directory exists",
            "tags": [
              "filesystem"
            ]
          },
          {
            "ansible.builtin.file": {
              "group": "storefront",
              "mode": "0750",
              "owner": "storefront",
              "path": "/srv/apps/storefront-api/{{ item }}",
              "state": "directory"
            },
            "loop": [
              "releases",
              "shared",
              "logs",
              "tmp"
            ],
            "name": "Ensure standard subdirectories exist",
            "tags": [
              "filesystem"
            ]
          },
          {
            "ansible.builtin.copy": {
              "content": "APP_NAME=storefront-api\nAPP_ENV=production\nLOG_LEVEL=info\nHTTP_PORT=8080\nDATABASE_URL=postgres://storefront@db-primary.internal:5432/storefront\nREDIS_URL=redis://redis-primary.internal:6379/0",
              "dest": "/srv/apps/storefront-api/.env",
              "group": "storefront",
              "mode": "0640",
              "owner": "storefront"
            },
            "name": "Render environment file from values",
            "notify": [
              "restart storefront-api"
            ],
            "tags": [
              "config"
            ]
          },
          {
            "ansible.builtin.template": {
              "dest": "/etc/systemd/system/storefront-api.service",
              "group": "root",
              "mode": "0644",
              "owner": "root",
              "src": "templates/storefront-api.service.j2"
            },
            "name": "Render systemd service unit",
            "notify": [
              "restart storefront-api"
            ],
            "tags": [
              "config",
              "systemd"
            ]
          },
          {
            "ansible.builtin.service": {
              "enabled": true,
              "name": "storefront-api",
              "state": "started"
            },
            "name": "Ensure service is started and enabled",
            "tags": [
              "service"
            ]
          }
        ],
        "vars": {
          "app_group": "storefront",
          "app_name": "storefront-api",
          "app_user": "storefront",
          "deploy_root": "/srv/apps",
          "healthcheck_url": "https://storefront.internal/health",
          "maintenance_window": "02:00-03:00 UTC",
          "release_channel": "stable",
          "runtime_env": "production",
          "service_name": "storefront-api"
        },
        "vars_files": [
          "group_vars/app_servers.yml",
          "vault/storefront-api.vault.yml"
        ]
      },
      {
        "any_errors_fatal": false,
        "become": true,
        "become_method": "sudo",
        "gather_facts": true,
        "handlers": [
          {
            "ansible.builtin.service": {
              "name": "background-worker",
              "state": "restarted"
            },
            "name": "restart background-worker"
          },
          {
            "ansible.builtin.service": {
              "name": "background-worker",
              "state": "reloaded"
            },
            "name": "reload background-worker"
          }
        ],
        "hosts": "worker_servers",
        "max_fail_percentage": 10,
        "name": "Deploy background-worker to worker_servers",
        "pre_tasks": [
          {
            "ansible.builtin.apt": {
              "cache_valid_time": 3600,
              "update_cache": true
            },
            "name": "Ensure apt cache is up to date",
            "tags": [
              "bootstrap",
              "packages"
            ]
          },
          {
            "ansible.builtin.package": {
              "name": [
                "curl",
                "jq",
                "python3",
                "rsync"
              ],
              "state": "present"
            },
            "name": "Install base operating system packages",
            "tags": [
              "bootstrap",
              "packages"
            ]
          },
          {
            "ansible.builtin.user": {
              "create_home": false,
              "name": "worker",
              "shell": "/usr/sbin/nologin",
              "system": true
            },
            "name": "Create dedicated application user",
            "tags": [
              "identity"
            ]
          }
        ],
        "roles": [
          {
            "role": "datadog.datadog",
            "vars": {
              "datadog_checks": {
                "process": {
                  "init_config": {},
                  "instances": [
                    {
                      "exact_match": false,
                      "name": "background-worker",
                      "search_string": [
                        "background-worker"
                      ]
                    }
                  ]
                }
              },
              "datadog_site": "datadoghq.com"
            }
          },
          {
            "role": "geerlingguy.firewall",
            "vars": {
              "firewall_allowed_tcp_ports": [
                22,
                9090
              ]
            }
          }
        ],
        "serial": 2,
        "strategy": "free",
        "tasks": [
          {
            "ansible.builtin.file": {
              "group": "worker",
              "mode": "0755",
              "owner": "worker",
              "path": "/srv/workloads/background-worker",
              "state": "directory"
            },
            "name": "Ensure release directory exists",
            "tags": [
              "filesystem"
            ]
          },
          {
            "ansible.builtin.file": {
              "group": "worker",
              "mode": "0750",
              "owner": "worker",
              "path": "/srv/workloads/background-worker/{{ item }}",
              "state": "directory"
            },
            "loop": [
              "releases",
              "shared",
              "queue",
              "tmp"
            ],
            "name": "Ensure standard subdirectories exist",
            "tags": [
              "filesystem"
            ]
          },
          {
            "ansible.builtin.copy": {
              "content": "APP_NAME=background-worker\nAPP_ENV=production\nLOG_LEVEL=warn\nWORKER_CONCURRENCY=12\nQUEUE_BACKEND=redis\nREDIS_URL=redis://redis-primary.internal:6379/1",
              "dest": "/srv/workloads/background-worker/.env",
              "group": "worker",
              "mode": "0640",
              "owner": "worker"
            },
            "name": "Render environment file from values",
            "notify": [
              "restart background-worker"
            ],
            "tags": [
              "config"
            ]
          },
          {
            "ansible.builtin.template": {
              "dest": "/etc/systemd/system/background-worker.service",
              "group": "root",
              "mode": "0644",
              "owner": "root",
              "src": "templates/background-worker.service.j2"
            },
            "name": "Render systemd service unit",
            "notify": [
              "restart background-worker"
            ],
            "tags": [
              "config",
              "systemd"
            ]
          },
          {
            "ansible.builtin.service": {
              "enabled": true,
              "name": "background-worker",
              "state": "started"
            },
            "name": "Ensure service is started and enabled",
            "tags": [
              "service"
            ]
          }
        ],
        "vars": {
          "app_group": "worker",
          "app_name": "background-worker",
          "app_user": "worker",
          "deploy_root": "/srv/workloads",
          "healthcheck_url": "https://worker.internal/health",
          "maintenance_window": "02:00-03:00 UTC",
          "release_channel": "canary",
          "runtime_env": "production",
          "service_name": "background-worker"
        },
        "vars_files": [
          "group_vars/worker_servers.yml",
          "vault/background-worker.vault.yml"
        ]
      }
    ]
  }
}
